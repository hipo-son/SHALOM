# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- **MCP Server — Claude Code Integration** (`shalom/mcp_server.py`)
  - FastMCP v1.x server exposing 10 DFT tools via Model Context Protocol
  - 9 deterministic tools (no API key needed): `search_material`, `generate_dft_input`, `run_workflow`, `execute_dft`, `parse_dft_output`, `plot_bands`, `plot_dos`, `run_convergence`, `check_qe_setup`
  - 1 LLM-driven tool: `run_pipeline` (full multi-agent pipeline; requires API key or `base_url`)
  - `.mcp.json` project-scoped config for auto-registration in Claude Code
  - `[mcp]` optional dependency extra: `pip install "shalom[mcp]"`
  - stdio transport with strict stdout isolation (all logging to stderr)
- **Local LLM Support** (`shalom/core/llm_provider.py`)
  - `base_url` parameter for OpenAI-compatible local servers (Ollama, vLLM, llama.cpp, LM Studio)
  - `SHALOM_LLM_BASE_URL` env var fallback (used by LLMProvider, CLI, MCP)
  - API key check skipped when `base_url` is set (dummy key `"local"` used)
  - Anthropic provider also supports `base_url` for self-hosted proxies
  - CLI: `--base-url` flag on `pipeline` subcommand
  - MCP: `base_url` parameter on `run_pipeline` tool
- **Audit Logging** (`shalom/core/audit.py`)
  - JSON-line file logging activated by `SHALOM_AUDIT_LOG` env var
  - Records `llm_call` and `pipeline_start` events with UTC timestamps
  - Lazy-initialized singleton logger, never blocks execution on failure
  - Integrated into `LLMProvider.generate_structured_output()` and `Pipeline.run()`
- **SafeExecutor Hardening** (`shalom/core/sandbox.py`)
  - Whitelist-only builtins: `eval`, `exec`, `compile`, `open`, `breakpoint` explicitly blocked
  - Attribute introspection blocked: `getattr`, `setattr`, `delattr` (prevents `__class__` escape)
  - Scope inspection blocked: `globals`, `locals`, `vars`
  - Metaclass manipulation blocked: `type` (prevents `__subclasses__` escape)
  - Added safe utilities: `sorted`, `map`, `hasattr`, `isinstance`
- **LLM Pipeline CLI** (`python -m shalom pipeline`)
  - Full multi-agent material discovery from the command line
  - `--provider`, `--model`, `--material`, `--steps`, `--selector-mode`, `--max-loops` flags
  - `--base-url` for local LLM servers
- **80 new tests** (1124 total, 94.6% coverage): MCP server tools (54 tests in `test_mcp_server.py`), LLMProvider base_url (4), SafeExecutor hardening (6), audit logging (2), pipeline base_url integration (14)
- **Materials Project (MP) API Integration Router** (`shalom/pipeline.py`)
  - Added Fast Track routing to bypass AI generation and fetch accurate structures directly via `mp_client.fetch_structure`
  - Seamless fallback logic to `GeometryGenerator` if the requested material is novel or MP search fails
- **Band/DOS visualisation** (`shalom/plotting/` — optional; `pip install shalom[plotting]`)
  - `BandStructurePlotter`: band structure plot with high-symmetry tick labels (`Dict[int, str]` index keys), spin-polarised two-colour rendering (royalblue / crimson), Fermi-level shift, energy window clamping, PNG export
  - `DOSPlotter`: total/spin-polarised DOS with mirrored spin-down convention, integrated DOS overlay, fill shading, Fermi-level vertical line, energy window support
  - `_format_label()` helper: maps "G"/"Gamma"/"GAMMA" → "Γ", passthrough for unknown labels
  - matplotlib imported lazily; `ImportError` raised with `pip install shalom[plotting]` hint when absent
- **QE output parsers** (`shalom/backends/qe_parser.py`)
  - `parse_xml_bands(xml_path, fermi_energy)`: reads `data-file-schema.xml` (QE 7.x), converts eigenvalues Hartree→eV (`HA_TO_EV = 27.2114`), builds `kpath_distances` from reciprocal-lattice vectors, detects `lsda` spin flag
  - `parse_dos_file(dos_path)`: parses `pwscf.dos` (dos.x output); auto-detects 3-column (non-spin) vs 4-column (spin-polarised); total DOS = dos_up + dos_down
  - `find_xml_path(calc_dir, prefix)`: three-location search (`{dir}/{prefix}.save/`, `{dir}/tmp/{prefix}.save/`, glob fallback)
  - `extract_fermi_energy(pw_out_path)`: regex extraction from `pw.out` (`the Fermi energy is … ev`, case-insensitive)
  - `compute_nbnd(atoms, multiplier=1.3)`: auto-compute `nbnd` from SSSP z_valence → `max(20, ceil(n_occ × multiplier))`
  - Constants exported: `HA_TO_EV`, `QE_XML_NS`
- **Backend-agnostic result dataclasses** (`shalom/backends/base.py`)
  - `BandStructureData`: eigenvalues (eV), kpath_distances, high_sym_labels `Dict[int, str]`, optional spin_up/spin_down arrays, source tag ("qe"/"vasp")
  - `DOSData`: energies (eV), dos, integrated_dos, optional dos_up/dos_down, source tag
- **K-path generation** (`shalom/backends/qe_config.py`)
  - `get_band_calc_atoms(atoms, is_2d)`: extracts seekpath's standardized primitive cell so that `crystal_b` k-coordinates are consistent with `CELL_PARAMETERS`; returns `None` for 2D structures or when seekpath is unavailable
  - `generate_band_kpath(atoms, npoints, is_2d)`: three-tier fallback (seekpath → ASE `cell.bandpath()` → hardcoded table); handles BZ path discontinuities (e.g. X→U jumps) as composite labels "X|U" with `npts=1` (prevents spurious band segments); `_FALLBACK_KPATHS` extended from 5 to 8 types (+TET, BCT, RHL)
  - `QEKPointsConfig` extended with `kpath_points: List[Tuple[List[float], int]]` and `kpath_labels: Dict[int, str]`
- **`_format_label()` composite label support** (`shalom/plotting/band_plot.py`): `"G|K"` → `"Γ|K"` at band-path discontinuity tick marks
- **Convergence workflows** (`shalom/workflows/`)
  - `ConvergenceWorkflow` ABC (`base.py`): per-atom convergence threshold (1 meV/atom default), sequential/parallel run dispatch, `_find_converged_value()`, `plot()` interface
  - `CutoffConvergence` (`convergence.py`): sweeps `ecutwfc` values with fixed k-mesh; `ecutrho` maintained at SSSP ratio; convergence plot (energy vs. ecutwfc)
  - `KpointConvergence` (`convergence.py`): sweeps k-point resolution (Bohr⁻¹ → Monkhorst-Pack grid) with fixed `ecutwfc`; convergence plot (energy vs. k-mesh density)
  - `ConvergenceResult` / `ConvergenceTestResult` dataclasses with `.summary()` and `.converged_results` property
- **5-step QE workflow** (`shalom/workflows/standard.py`)
  - `StandardWorkflow`: orchestrates vc-relax → scf → bands → nscf → dos.x → band/DOS plots in a single call
  - Primitive cell consistency: after vc-relax, converts to seekpath primitive cell (via `get_band_calc_atoms()`) so SCF, bands, and NSCF share the same cell and charge density transfer is valid
  - k-path pre-computed once (`self._kpath_cfg`) and reused by `_run_bands()` and `_plot_bands()`; `_plot_bands()` collapses x-axis gaps at discontinuities (standard band-structure convention)
  - Absolute `outdir` path sharing between scf, bands, and nscf (HPC-safe)
  - dos.x input energies in Ry (`EV_TO_RY = 1/13.6057`); dos.x run serial (nprocs=1)
  - Fermi energy priority: NSCF > SCF (metals may differ by 10–100 meV)
  - `--skip-relax` flag to restart from existing structure
  - Returns dict with `bands_png`, `dos_png`, `fermi_energy`, `atoms` (primitive cell), and per-step `calc_dirs`
- **New CLI subcommands** (`shalom/__main__.py`)
  - `python -m shalom plot <dir>` — generate band or DOS plot from completed calculation
  - `python -m shalom workflow <formula>` — run full 5-step pipeline
  - `python -m shalom converge <formula>` — run cutoff or k-point convergence test
- **`parse_output_bands()`** method on `QEBackend` — bands/nscf result parsing (convergence via "JOB DONE.", energy=None, forces=None)
- **nscf preset improvements** (`qe_presets.yaml`, `_defaults.py`)
  - `occupations: tetrahedra_opt` (replaces `tetrahedra`) for improved DOS integration accuracy
  - `nosym: true`, `noinv: true` — full BZ sampling required for DOS
- **`[plotting]` optional dependency extra** (`pyproject.toml`): `matplotlib>=3.5.0`, `seekpath>=2.0.0`
- **63 new tests** (922 passed, 1 skipped): `test_qe_parser.py` (26), `test_band_plot.py` (13), `test_dos_plot.py` (6), `test_convergence.py` (13), `test_standard_workflow.py` (9), `test_qe_config.py` (11 new: `TestGetBandCalcAtoms`, `TestGenerateBandKpath`); fixtures: `mock_bands_xml.xml`, `mock_dos.dat`, `mock_dos_spin.dat`
- **122 new tests** (1044 passed, 1 skipped; 94.6% coverage) closing coverage gaps across CLI, workflows, parsers, and plotting:
  - `test_cli_main.py`: 10 new test classes covering `cmd_plot`, `cmd_workflow`, `cmd_converge`, `_load_atoms`, `_execute_dft`, `_detect_wsl_distros`, `_print_install_guide_windows/linux`, `main()` dispatcher (~50 tests)
  - `test_standard_workflow.py`: 66 tests for `StandardWorkflow` lifecycle, step isolation, error propagation, and `_plot_bands()` gap-collapse logic
  - `test_convergence.py`: 28 tests for `CutoffConvergence`/`KpointConvergence` including parallel path, `_run_single` error handling, `summary()` output, and plot creation
  - `test_qe_parser.py`: 11 edge-case tests (malformed XML, missing k_point, spin-polarised detection, `find_xml_path` glob fallback, `parse_dos_file` single-row reshape)
  - `test_direct_run.py`: 11 tests for `_write_output_readme()` and error-path branches (no structure, `write_input` exception, MP import error, unknown calc_type)
  - `test_dos_plot.py`: 2 tests (integrated DOS twin-axis rendering, `_require_matplotlib` ImportError)
  - `test_qe_config.py`: 6 tests for seekpath Tier 1 (continuous/discontinuous paths, exception fallback) and `_detect_bravais_lattice` error path

- **`setup-qe` CLI subcommand** (`python -m shalom setup-qe`)
  - QE prerequisite checker: pw.x detection, pseudo_dir validation
  - Per-element SSSP pseudopotential file checking with case-insensitive fallback
  - `--download` flag: auto-download missing UPFs from SSSP repository
  - Platform-aware install instructions (apt, conda, WSL2)
- **UPF file validation in `runner.py`**: parses ATOMIC_SPECIES from pw.in to verify each pseudopotential file exists before execution
- **Improved error messages**: missing pw.x/mpirun now shows install instructions and `setup-qe` reference
- **QE integration test** (`test_integration.py`): real Si SCF test, skipped without pw.x
- **QE Local Execution** (`--execute` CLI flag, `runner.py`, `qe_error_recovery.py`)
  - `ExecutionRunner`: subprocess-based pw.x execution with threading.Timer timeout, SIGINT cleanup
  - `execute_with_recovery()`: automatic error recovery loop with progressive correction escalation
  - `QEErrorRecoveryEngine`: 14 QE error patterns (verified against QE 7.x), 10 correction strategies
  - S-matrix diagnostic branching: atomic overlap vs basis-set path (physics-aware)
  - Light atom dt safety: H→5, Li→10, Be→12 Ry a.u. (prevents explosion in damped dynamics)
  - Quality warnings: `loosely_relaxed`, `vc_relax_downgraded` tags on `DFTResult`
  - Per-step iteration caps: local-TF fast-fail (50-step) to avoid divergence on insulators
  - Pipeline integration: `EXECUTION` step, `FAILED_EXECUTION` status, `quality_warnings` on `PipelineResult`
  - CLI flags: `--execute/-x`, `--nprocs/-np`, `--timeout`, `--mpi-command`
  - 148 new tests (824 total, 93.4% coverage)
- **Flexible Pipeline** (`pipeline.py`)
  - `PipelineStep` enum for step-selective execution (`design`, `simulation`, `review`)
  - `synthesize_ranked_material()` with ASE formula parsing + physics-aware defaults (magnetic, GGA+U)
  - `PipelineConfig` fields: `steps`, `material_name`, `input_structure_path`, `input_ranked_material`
  - `PipelineResult` fields: `elapsed_seconds`, `config_snapshot`
  - `COMPLETED_DESIGN` pipeline status for design-only runs
  - `pipeline_config.json` saved alongside `pipeline_state.json` for reproducibility
  - 33 new tests (676 total, 95.7% coverage)
- **`compute_forces_max()`** shared helper in `backends/base.py` (deduplicated from VASP/QE)
- **Token-aware error log compression** (`shalom/backends/_compression.py`)
  - `compress_error_log()`: keyword-preserving + tail extraction with token budget enforcement
  - `truncate_to_tokens()`, `truncate_list()`, `estimate_tokens()` utilities
  - Loads VASP error keywords from `error_patterns.yaml` (single source of truth)
- **QE error_log support** — `qe.py` now attaches compressed error log for unconverged runs
- **Agent Guidelines** (`AGENT_GUIDELINES.md`) with QE-specific domain knowledge (Rydberg units, SSSP, magnetism, 2D)
- 44 new tests (643 total, 95.6% coverage): compression utilities, CLI cmd_run/main, QE error_log, review physics checks
- **Configuration externalization system** (`_config_loader.py`, `_config_schemas.py`, `_defaults.py`)
  - `load_prompt(name)` loads LLM system prompts from `shalom/prompts/*.md`
  - `load_config(name)` loads physics/VASP settings from `shalom/config/*.yaml`
  - Built-in fallback defaults in `_defaults.py` ensure operation without external files
  - Deep-copy protection on mutable config returns prevents cache poisoning
  - Fail-Fast on YAML syntax errors (corrupted files never silently fall back)
  - CRLF normalization for Windows cross-platform compatibility
  - Pydantic schema validation for critical configs (POTCAR mapping, Hubbard U)
- 11 LLM prompt files in `shalom/prompts/` (`.md` format, version-tagged)
- 9 physics config files in `shalom/config/` (`.yaml` format with literature references)
- `ShalomConfigurationError` custom exception for config/prompt loading failures
- `test_config_loader.py` with 25 tests covering loader, schemas, caching, and fallback
- `.gitattributes` for line-ending normalization
- `pyyaml>=6.0` dependency
- POTCAR dataset version metadata (`potcar_version: "54"`)
- Hubbard U functional dependency tag (`functional: "PBE"`)

### Changed
- `vasp.py` error log uses `compress_error_log()` (replaces raw `lines[-100:]` slice)
- `review_layer.py` caps `correction_history` at 20 entries, token-budget-aware error log insertion (80K default)
- `base.py` `DFTResult.error_log` documented as compressed (not for `scan_for_errors()`)
- Ionic step history (`energies`, `forces_history`, `magmoms`) capped at 50 entries in VASP/QE backends
- Agent system prompts externalized from Python strings to `shalom/prompts/*.md`:
  - `design_layer.py`: CoarseSelector, FineSelector prompts
  - `evaluators.py`: 6 specialist evaluator prompts + confidence rule + weights/thresholds
  - `simulation_layer.py`: GeometryGenerator prompt
  - `review_layer.py`: ReviewAgent prompt
- Physics constants externalized from Python dicts to `shalom/config/*.yaml`:
  - `vasp_config.py`: POTCAR mapping, ENMAX values, MAGMOM defaults, Hubbard U, metallic elements, INCAR presets
  - `error_recovery.py`: error patterns, correction strategies
- **Net code reduction: -404 lines hardcoded data, +53 lines loader calls** (7 modified files)
- All existing tests pass unchanged (zero behavioral change)

### Fixed
- `test_standard_workflow.py`: corrected 4 `BandStructureData` fixture instantiations that omitted the required `kpoint_coords` positional argument (exposed by dataclass field ordering change)
- `test_convergence.py`: added `matplotlib.use("Agg")` + `plt.switch_backend("Agg")` guard to `test_convergence_plot_creates_file` to prevent `_tkinter.TclError: main thread is not in main loop` on Windows when running the full test suite
- `standard.py` `_plot_bands()`: x-axis gaps at BZ path discontinuities — cumulative distance is now reset at break points (composite "X|U" labels) so sub-paths are plotted side-by-side with zero gap (standard scientific convention; previously the X→U jump distance inflated the x-axis)
- `qe_config.py` `generate_band_kpath()` Tier 2: partial results from a failed ASE `cell.bandpath()` call are now discarded before Tier 3 runs (previously partial `seg_labels` could bypass Tier 3 and produce an incomplete k-path)
- `standard.py` `run()`: corrected `"atoms"` return-dict docstring (now returns seekpath primitive cell, not the raw vc-relax output)
- `qe.py`: JOB DONE convergence bug — "convergence NOT achieved" now overrides JOB DONE signal
- `simulation_layer.py`: QE backend now uses default `pw.in` filename instead of `POSCAR_{name}`
- `design_layer.py`: guard against empty candidates list (IndexError on veto fallback)
- `evaluators.py`: safe fallback when LLM hallucinates unknown material name (StopIteration → None check)
- `_physics.py`: `compute_kpoints_grid` guards against empty Atoms / zero-volume cell (LinAlgError)
- `qe.py`: magnetization float parsing with try/except for QE overflow format
- `_compression.py`: log WARNING on config load failure instead of silent fallback
- `vasp.py`: log WARNING on pymatgen vasprun.xml parse failure instead of silent `pass`
- `direct_run.py`: `potcar_preset` type narrowed to `Literal`, `ase_read` union result handled
- `review_layer.py`: renamed `warnings` local variable to avoid shadowing stdlib `warnings`
- `evaluators.py`: moved `import json` from method body to module-level
- `llm_provider.py`: removed duplicate `raise ValueError` (dead code on line 113)

### Previous [Unreleased] changes
- GitHub Actions CI/CD workflows for testing, linting, and PyPI release
- Cross-platform `SafeExecutor` sandbox with `ThreadPoolExecutor` timeout fallback for Windows
- `ReviewAgent` with OUTCAR parsing and LLM-based result evaluation
- `ReviewResult` Pydantic schema for closed-loop feedback
- Comprehensive test suites: `test_sandbox.py`, `test_llm_provider.py`, expanded FormFiller edge cases
- Reproducibility infrastructure with explicit `seed` and `temperature=0.0` in LLM calls
- Dockerfile and `environment.yml` for HPC/SLURM containerization
- Sphinx documentation with `napoleon`, `nbsphinx`, `intersphinx` extensions
- Community files: `CITATION.cff`, `CODE_OF_CONDUCT.md`, `CONTRIBUTING.md`
- `[all]` optional dependency group in `pyproject.toml`
- Pydantic `score` field validation (`ge=0.0, le=1.0`)
- All agent system prompts and feedback messages translated to English
- All Pydantic `Field` descriptions translated to English
- `ruff` and `mypy` target versions aligned to `py39` (minimum supported)
- `anthropic` minimum version raised to `>=0.25.0`
- Coverage threshold unified to 85% across CI, `pyproject.toml`, and `CONTRIBUTING.md`

## [0.1.0] - 2026-02-22

### Added
- Core framework: `LLMProvider` with OpenAI and Anthropic structured output support
- Pydantic schemas: `MaterialCandidate`, `RankedMaterial`, `StructureReviewForm`, `AgentMessage`
- Design Layer: `CoarseSelector` (3-5 candidate screening) and `FineSelector` (precision ranking)
- Simulation Layer: `GeometryGenerator`, `FormFiller` (rule-based validation), `GeometryReviewer` (feedback loop)
- Tools: `ASEBuilder` with `construct_bulk`, `construct_surface`, `save_poscar`, `analyze_structure`
- Unit tests with mock-based LLM testing
- Master design document and Sphinx documentation scaffolding
